@model TimeSheet.Models.Sheet
@{
    ViewBag.Title = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<nav class="navbar navbar-fixed-top navbar-inverse" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/Home/">RDSS Timesheet</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul class="nav navbar-nav">
            <li><a href="#about">About</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#contact">Contact</a></li>
        </ul>
        <ul class="nav navbar-nav pull-right">
            <li><a href="#"><i class="icon-user icon-white"></i> @Model.User</a></li>
            <li><a href="#"><i class="icon-question icon-white"></i></a></li>
        </ul>
    </div>
    <!-- /.navbar-collapse -->
</nav>
<div class="container">
    <div class="row">
        <div class="col-sm-6">
            @using (var f = Html.Bootstrap().Begin(new Form("Index", "Home").Id("sheetform").Type(FormType.Horizontal).LabelWidthSm(4)))
            {
                @f.FormGroup().DisplayTextFor(m => m.employee.FirstName).Label().LabelText("FirstName")
                @f.FormGroup().DisplayTextFor(m => m.employee.LastName).Label().LabelText("LastName")
                @f.FormGroup().DisplayTextFor(m => m.employee.EmployeeNumber).Label().LabelText("Number")
                @f.FormGroup().TextBoxFor(m => m.sunday).Placeholder("on a Sunday").Class("datepicker").Size(InputSize.Small).WidthSm(4).Label().LabelText("Ending")
                <div class="form-group">
                    <label class="control-label col-sm-4" id="weeklabel">Week
                    <span style="visibility:hidden;">*</span></label>
                    <table class="weekmover">
                        <thead>
                            <tr>
                                <th>
                                    <button class="btn btn-success btn-small" id="priorsheet">
                                        <i class="icon-step-backward icon-large"></i>
                                    </button>
                                </th>
                                <th>
                                    <div id="weeknumber" class="form-control-static">@Model.weekNumber</div>
                                </th>
                                <th>
                                    <button class="btn btn-success btn-small" id="nextsheet">
                                        <i class="icon-step-forward icon-large"></i>
                                    </button>
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
            }
        </div>
        <div class="col-sm-6">
            @using (Html.Bootstrap().Begin(new Table().Caption("Hours Summary").Condensed().Class("pull-right hoursum")))
            {
                <tr><td>Demand</td><td class="day">@Model.Stats[0]</td></tr>
                <tr><td>Non-Demand</td><td class="day">@Model.Stats[1]</td></tr>
                <tr><td>Overtime</td><td class="day">@Model.Stats[2]</td></tr>
                <tr><td><b>Total</b></td><td class="day"><b>@Model.Stats[3]</b></td></tr>
            }
        </div>
    </div>
</div>
<div id="content">
    <table id="week" class="table table-striped @(Model.Submitted?"":"table-hover") table-condensed table-bordered">
        <thead @(Model.Submitted ? "class=locked" : "")>
            <tr class="sheetline">
                <th class="addbutton" colspan="4">
                    @if (!Model.Submitted)
                    {
                        <button class="btn btn-success btn-mini pull-left" id="addline">
                            <i class="icon-plus icon-white"></i> New Row
                        </button>
                    }
                </th>
                @Html.DisplayFor(m => m.Headers)
                <th><i class="icon-sitemap"></i></th>
                <th class="submitbutton" colspan="5">
                    @if (Model.hours.Count() > 0)
                    {
                        if (!Model.Submitted)
                        {
                            using (var subform = Html.Bootstrap().Begin(new Form("Submit", "Home").Id("submitsheet").Type(FormType.Horizontal)))
                            {
                                @Html.Hidden("WorkerId", Model.employee.WorkerId)
                                @Html.HiddenFor(m => m.weekNumber)
                                @Html.Bootstrap().SubmitButton().Text("Submit").Style(ButtonStyle.Danger).PrependIcon("icon-power-off icon-white").Class("pull-right")
                            }
                        }
                        else
                        {
                            <div class="text-danger pull-right">
                                <i class="icon-lock"></i> @Model.hours[0].Submitted.ToString()
                            </div>
                        }
                    }
                </th>
            </tr>
            <tr id="sheetrow">
                <th title="Overtime"><i class="icon-time"></i></th>
                <th>Description</th>
                <th>Cust Acct</th>
                <th>GL Acct</th>
                <th class="day">@Model.Stats[4]</th>
                <th class="day">@Model.Stats[5]</th>
                <th class="day">@Model.Stats[6]</th>
                <th class="day">@Model.Stats[7]</th>
                <th class="day">@Model.Stats[8]</th>
                <th class="day">@Model.Stats[9]</th>
                <th class="day">@Model.Stats[10]</th>
                <th class="day subt">@Model.Stats[3]</th>
                <th title="New Request"><i class="icon-asterisk"></i></th>
                <th>Customer</th>
                <th>WorkArea</th>
                <th>Partner</th>
                <th>Site</th>
            </tr>
        </thead>
        <tbody>
            @Html.DisplayFor(m => m.hours)
            @Html.DisplayFor(m => m.CarryOver)
        </tbody>
    </table>
</div>

<div id="weekline"></div>

@section scripts {
    <script type="text/javascript">
        var week, sheet, $cust, $desc;
        var sunday = '@Model.sunday';
        var empid = '@Model.employee.WorkerId';

        function switchUI() {
            if ($('#PartnerId').find('option:selected').html() == 'RDSS') {
                $('.nondemand').parent().parent().css('display', 'block');
                $('.demand').parent().parent().css('display', 'none');
            }
            else {
                $('.nondemand').parent().parent().css('display', 'none');
                $('.demand').parent().parent().css('display', 'block');
            }
        }

        function getHours(hrs, mns) {
            hrs += Math.floor(mns / 60);
            mns %= 60;
            return hrs + ":" + (mns < 10 ? "0" : "") + mns;
        }

        function getMins(str) {
            var part = str.split(":");
            return parseInt(part[0]) * 60 + parseInt(part[1]);
        }

        function newWeek(next) {
            var days = next ? 7 : -7;
            var newSunday = new Date(sunday);
            newSunday.setDate(newSunday.getDate() + days);
            sunday = $.datepicker.formatDate('mm/dd/yy', newSunday);
            $('#periodEnding').val(sunday);
            week = $.datepicker.iso8601Week(newSunday);
            var url = '@Url.Action("Index", "Home", new { id = -1 })';
            location.href = url.replace('-1', week);
        }

        function resumLine(line) {
            var hrs = 0;
            var mns = 0;
            $('input', 'tr#' + line + '.hourline').each(function () {
                hrs += Number($(this).val().substr(0, 2));
                mns += Number($(this).val().substr(3, 2));
            });
            $('#hrs' + line, 'tr.hourline').html(getHours(hrs, mns));
        }

        function clrhours() {
            $('[name=options]', $desc).val('');
            $('[name=options]', $cust).val('');
            //$desc.data('combobox').refresh();
            //$cust.data('combobox').refresh();
            $('#modaltitle').html('Add Hours');
            $('input', 'tr.hourline').val('');
            $('select option[value="0"]').attr('selected', true);
            $('td.hrsum[id^="hrs"]', 'tr.hourline').html('');
        }
        function popuploaded() {
            $cust = $('#CustomerId', '#weeksheet');
            $desc = $('#DescriptionId', '#weeksheet');
            $intn = $('#InternalNumberId', '#weeksheet');
            $desc.combobox({ freeform: '#DescriptionAdd', selected: true });
            $cust.combobox({ freeform: '#CustomerAdd', selected: true });
            $intn.combobox({ freeform: '#InternalNumberAdd', selected: true });

            switchUI();
            resumLine("normal");
            resumLine("overtime");

            $('#weekline').modal('show');
            $('tr.hourline input').on('blur', function () {
                var newt = $(this).val().replace(/_/g, '0').split(':');
                var newhr = ($(this).val().charAt(1) == '_' && $(this).val().charAt(0) != '_') ? Number(newt[0].charAt(0)) : Number(newt[0]);
                newhr = newhr > 24 ? 8 : newhr;
                var g = getHours(newhr, Number(newt[1]));
                g = g.length < 5 ? '0' + g : g;
                $(this).val(g);
            });
            $('input', 'tr#normal.hourline').on('change', function (e) {
                resumLine("normal");
            });
            $('input', 'tr#overtime.hourline').on('change', function (e) {
                resumLine("overtime");
            });
            $('#PartnerId').on('change', function () {
                switchUI();
            });
            $('#savehrs').on('click', function (e) {
                $('#weekline').modal('hide');
            });
            $('#deletehrs').on('click', function (e) {
                var normal = parseInt($('#WeekId').val());
                var overtime = parseInt($('#oWeekId').val());
                $('#weekline').modal('hide');
                e.preventDefault();
                location.href = '@Url.Action("Delete", "Home", null, Request.Url.Scheme)/' + normal + '/' + overtime;
            });
        }
        // Page loaded document ready
        $(function () {
            $('.datepicker').datepicker({
                beforeShowDay: function (date) { return [date.getDay() == 0, ""] }
                , firstDay: 1
            });
            $('.datepicker').on('change', function (e) {
                var test = new Date(e.target.value);
                if (test.getDay() != 0) {
                    console.log('@Url.Action("PickDate", "Home", null, Request.Url.Scheme)');
                    location.href = '@Url.Action("PickDate", "Home", null, Request.Url.Scheme)/' + $.datepicker.formatDate('yy-mm-dd', test);
                }
            });
            $('#priorsheet').on('click', function (e) {
                e.preventDefault();
                newWeek(false);
            });
            $('#nextsheet').on('click', function (e) {
                e.preventDefault();
                newWeek(true);
            });

            week = @(Model.weekNumber) +0;

            $('#periodEnding').val('@Model.sunday');

            @if (!Model.Submitted) {
            <text>
            $('#addline').on('click', function () {
                $.get('@Url.Action("Create","Home",null,Request.Url.Scheme)/0', function (data) {
                    $('#weekline').replaceWith(data);
                    popuploaded();
                });
            });
            $('#week tbody').on('click', 'tr.hoursrow', function () {
                var id = $(this).data('id');
                var pairid = $(this).data('pairid');
                id = (id != '') ? id : 0;
                pairid = (pairid != '') ? pairid : 0;

                $.get('@Url.Action("Edit","Home",null,Request.Url.Scheme)/' + id + '/' + pairid, function (data) {
                    $('#weekline').replaceWith(data);
                    popuploaded();
                });
            });
            </text>
        }

            $('#week tbody').on('click', 'tr.descriptionrow', function (e) {
                var id = $(this).data('id');
                var $cell = $(e.target).closest('td');
                if ($cell.index() == 0) {
                    location.href = '@Url.Action("InActivate", "Home", null, Request.Url.Scheme)/' + id + '/' + week;
                }
                $.get('@Url.Action("Create","Home",null,Request.Url.Scheme)/' + id, function (data) {
                    $('#weekline').replaceWith(data);
                    popuploaded();
                });
            });
        });
    </script>
}
